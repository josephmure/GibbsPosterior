library(pscl)
library(GenSA)

dossier_courant <- getwd()
setwd("../../..")
source("Briques_these")
source("MaxVraisemblanceIntegree.r")
source("densKernel.r")
setwd(dossier_courant)

NOMBRE_DIMENSIONS <- scan("nombre_dimensions.txt")
TYPE_NOYAU_MATERN <- "geometrique" #scan("type_noyau.txt", what="character")
REGULARITE <- read.table("regularite_vraie.txt",as.is=TRUE)$V1

TEMPS_RECUIT <- 10

if(TYPE_NOYAU_MATERN == "geometrique")
{
	Posterior<-as.matrix(read.table("Posterior_anis_geom.txt", as.is=TRUE))
}

if (TYPE_NOYAU_MATERN == "tensorise")
{
	Posterior<-as.matrix(read.table("Posterior_tens.txt", as.is=TRUE))
}


VECTEUR_GERMES_ALEATOIRES <- scan("liste_MAP_optim_classique.txt")

for(germe_aleatoire in VECTEUR_GERMES_ALEATOIRES)
{
    x_connus <- 

x_connus <- as.matrix(read.table("planXP.txt", as.is = TRUE))
y_connus <- scan("observations.txt")

opt <- optim(par=rep(0.5,NOMBRE_DIMENSIONS),fn = evalueOpposeLogVraisemblanceIntegreeAnisGeom, x_connus= x_connus, y_connus= y_connus, regularite=REGULARITE, method = "L-BFGS-B",lower = rep(0,NOMBRE_DIMENSIONS)) 

if(opt$convergence !=0) print(paste("Attention ! Pas de convergence de optim pour estimer le MLE. Code :", opt$convergence))

argmax_vraisemblance_integree <- opt$par

write.matrix(argmax_vraisemblance_integree, "argmax_vraisemblance_integree.txt")

recuit <- GenSA(par=rep(0.5,NOMBRE_DIMENSIONS), fn= densKernel, fenetre= 0.2, matrice_echantillon=Posterior, lower=rep(0,NOMBRE_DIMENSIONS), upper= rep(max(Posterior),NOMBRE_DIMENSIONS), control = list(max.time=TEMPS_RECUIT))

mode_posterior <- recuit$par

write.matrix(mode_posterior, "mode_posterior.txt")

opt_MAP <- optim(par=rep(0.5,NOMBRE_DIMENSIONS),fn = densKernel, fenetre= 0.2, matrice_echantillon=Posterior, method = "L-BFGS-B",lower = rep(0,NOMBRE_DIMENSIONS)) 

if(opt_MAP$convergence !=0) print(paste("Attention ! Pas de convergence de optim pour estimer le MAP. Code :", opt_MAP$convergence))

mode_posterior_optim_classique <- opt_MAP$par

write.matrix(mode_posterior_optim_classique, "mode_posterior_optim_classique.txt")
