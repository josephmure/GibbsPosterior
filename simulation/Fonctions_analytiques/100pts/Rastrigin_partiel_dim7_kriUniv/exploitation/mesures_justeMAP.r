library(pscl)
library(GenSA)

#TYPE_NOYAU_MATERN <- "geometrique" #scan("type_noyau.txt", what="character")

dossier_courant <- getwd()
setwd("../../../..")
source("Briques_these.r")
source("MaxVraisemblanceIntegree.r")
source("densKernel.r")
setwd(dossier_courant)

NOMBRE_DIMENSIONS <- scan("../nombre_dimensions.txt")
REGULARITE <- read.table("../regularite_vraie.txt",as.is=TRUE)$V1
MATRICE_DISTANCES <- NULL
MATRICE_DISTANCES_FISHER <- NULL
MATRICE_ECART_PREDICTION_MOYENNE_CONDITIONNELLE_JUSTE <- NULL
MATRICE_ERREURS_PREDICTION <- NULL
MATRICE_FREQUENCES_APPARTIENT_INTERVALLE_PARI <- NULL
#VECTEUR_FREQUENCE_APPARTIENT_INTERVALLE_PARI_BAYESIEN <- NULL
MATRICE_LONGUEURS_MOYENNES_INTERVALLES_PARI <- NULL

#TEMPS_RECUIT <- 10

#if(TYPE_NOYAU_MATERN == "geometrique")
#{
#	Posterior<-as.matrix(read.table("Posterior_anis_geom.txt", as.is=TRUE))
#}

#if (TYPE_NOYAU_MATERN == "tensorise")
#{
#	Posterior<-as.matrix(read.table("Posterior_tens.txt", as.is=TRUE))
#}


VECTEUR_GERMES_ALEATOIRES <- scan("../germes_aleatoires.txt")

LISTE_MLE <- as.matrix(read.table("../MLE.txt", as.is=TRUE))
LISTE_MAP <- as.matrix(read.table("../MAP.txt", as.is=TRUE))
LISTE_ECHANTILLONS_POSTERIOR <- as.matrix(read.table("../matrice_echantillons_posterior.txt"))
TAILLE_ECHANTILLON_POSTERIOR <- nrow(LISTE_ECHANTILLONS_POSTERIOR) / length(VECTEUR_GERMES_ALEATOIRES)


### AMENDEMENT PROVISOIRE A MESURES.R (AURAIT DEJA DU ETRE FAIT DANS COMMANDES.R)
#MLE <- NULL
#MAP <- NULL
##MAP_optim_classique <- NULL
### FIN AMENDEMENT PROVISOIRE


for(numero_germe_aleatoire in 1:length(VECTEUR_GERMES_ALEATOIRES))
{
    
    germe_aleatoire <- VECTEUR_GERMES_ALEATOIRES[numero_germe_aleatoire]
    source("../../generePlanXP.r")
    source("../../genereMatriceTendance.r")
    source("../../genereObservations.r")


    
    argmax_vraisemblance_integree <- LISTE_MLE[numero_germe_aleatoire,]
    mode_posterior <- LISTE_MAP[numero_germe_aleatoire,]
    write.matrix(argmax_vraisemblance_integree ,"argmax_vraisemblance_integree.txt",sep = "\t")
    write.matrix(mode_posterior, "mode_posterior.txt",sep = "\t")

	ECHANTILLON_POSTERIOR <- LISTE_ECHANTILLONS_POSTERIOR[(1+(numero_germe_aleatoire-1)*TAILLE_ECHANTILLON_POSTERIOR):(numero_germe_aleatoire*TAILLE_ECHANTILLON_POSTERIOR),]


### AMENDEMENT PROVISOIRE A MESURES.R (AURAIT DEJA DU ETRE FAIT DANS COMMANDES.R)
#	source("../../postTraitementProvisoire.r")


#	MLE <- rbind(MLE, argmax_vraisemblance_integree)
#print("coucou")
#	write.matrix(MLE,"liste_MLE.txt",sep = "\t")
#print("coucou2")
#	MAP <- rbind(MAP, mode_posterior)
#	write.matrix(MAP,"liste_MAP.txt",sep = "\t")
#	#MAP_optim_classique <- rbind(MAP_optim_classique, mode_posterior_optim_classique)
#	#write.matrix(MAP_optim_classique,"liste_MAP_optim_classique.txt", sep = "\t")

### FIN AMENDEMENT PROVISOIRE


	Indices_selectionnes <- 10* (1:(TAILLE_ECHANTILLON_POSTERIOR/10))
	ECHANTILLON_POSTERIOR <- ECHANTILLON_POSTERIOR[Indices_selectionnes,]



    source("../../compareResultats_justeMAP.r")

	MATRICE_DISTANCES <- rbind(MATRICE_DISTANCES, c( 0, Distance_mode_posterior[1]) )
	write.matrix(MATRICE_DISTANCES,"matrice_distances_justeMAP.txt",sep = "\t")

	MATRICE_DISTANCES_FISHER <- rbind(MATRICE_DISTANCES_FISHER, c( 0, Distance_mode_posterior[2]) )
	write.matrix(MATRICE_DISTANCES_FISHER,"matrice_distances_fisher_justeMAP.txt",sep = "\t")

	MATRICE_ECART_PREDICTION_MOYENNE_CONDITIONNELLE_JUSTE <- rbind ( MATRICE_ECART_PREDICTION_MOYENNE_CONDITIONNELLE_JUSTE,  Ecart_prediction_moyenne_conditionnelle_juste )
	write.matrix(MATRICE_ECART_PREDICTION_MOYENNE_CONDITIONNELLE_JUSTE,"matrice_ecarts_predictions_moyenne_cond_juste_justeMAP.txt",sep = "\t")

	MATRICE_ERREURS_PREDICTION <- rbind(MATRICE_ERREURS_PREDICTION, Ecart_prediction )
    write.matrix(MATRICE_ERREURS_PREDICTION,"matrice_ecarts_predictions_justeMAP.txt",sep = "\t")

    MATRICE_FREQUENCES_APPARTIENT_INTERVALLE_PARI <- rbind(MATRICE_FREQUENCES_APPARTIENT_INTERVALLE_PARI, Frequences_appartient_intervalle_pari )
    write.matrix(MATRICE_FREQUENCES_APPARTIENT_INTERVALLE_PARI, "matrice_frequences_appartient_intervalle_pari_justeMAP.txt", sep = "\t")

	#VECTEUR_FREQUENCE_APPARTIENT_INTERVALLE_PARI_BAYESIEN <- c(VECTEUR_FREQUENCE_APPARTIENT_INTERVALLE_PARI_BAYESIEN, Frequence_appartient_intervalle_pari_full_bayesien)
	#write.matrix(VECTEUR_FREQUENCE_APPARTIENT_INTERVALLE_PARI_BAYESIEN, "vecteur_frequence_appartient_intervalle_pari_bayesien.txt", sep= "\t")

	MATRICE_LONGUEURS_MOYENNES_INTERVALLES_PARI <- rbind(MATRICE_LONGUEURS_MOYENNES_INTERVALLES_PARI,  Longueurs_moyennes_intervalles_pari )
	write.matrix(MATRICE_LONGUEURS_MOYENNES_INTERVALLES_PARI, "matrice_longueurs_moyennes_intervalles_pari_justeMAP.txt", sep = "\t")
}
